## Task - 触觉底座与无感统一训练路线图（Stage 1 规划）

参考来源：Notion任务页（总体目标与阶段设计） - [链接](https://www.notion.so/29313e5ef00580baa197f9383ed89187?source=copy_link)

### 1) 我们要做什么（一句话）
构建一个纯触觉域、跨传感器无感、具多层次语义输出的基础模型：先用全量无标签触觉数据自监督学习底层表征，再以TacQuad建立跨传感器“无感锚点”，随后联合学习三层显式任务语义，最后以无配对去域方式弱化残余域差并稳定泛化。

### 2) 为什么这样做（设计原则）
- 先稳后强：先学触觉通用规律（几何+短期时序），再做跨传感器无感，再学任务语义，最后做弱无感补强，避免“尚未学会触觉就过早对齐”。
- 可验证闭环：每阶段都有可量化指标（LoSO、域探针、任务指标、Wandb三角指标），方便Go/No-Go决策。
- 风险可控：优先使用工程可落地的机制（MAE、对比对齐、GradNorm/不确定性加权、DANN、token一致性），逐步升温、随时回滚。

---

## 阶段拆解与合理性论证

### Phase ① State0：触觉底座自监督（全数据）
- 目标：学习触觉几何与短期时序一致性，得到通用编码器 φ₀。
- 输入：全体无标签触觉数据（TacQuad、TAG、TVL、Feel、其他）。
- 方法（与当前实现一致）：
  - 静态：第1帧MAE掩码重建（高掩码率，强上下文建模）。
  - 动态：前3帧掩码重建 + 第4帧整帧预测（显式时序建模）。
  - 训练：联合训练（同批静/动加权 α/β）优于交替；AMP+DDP+梯度累积；Cosine+Warmup。
- 符号说明（用于State0损失公式）：
  - L：补丁数（每帧空间位置数），由补丁化得到，L = (H/p)×(W/p)。对“全补丁”求平均时使用（如第4帧预测的 1/L ∑）。
  - 𝓜：被掩码的补丁索引集合，𝓜 = { i | m_i = 1 }，|𝓜| 为其基数。在“掩码区域”求平均时使用（如第1帧与前3帧重建的 1/|𝓜| ∑）。
- 指标（Wandb）：
  - 三角指标：batch/loss_total 下降、batch/loss_ratio 稳定(0.7–1.0)、static/dynamic_contribution≈权重期望。
  - 分解一致性：loss_dynamic = loss_recon + loss_pred（恒成立）。
- 合理性：
  - MAE高掩码学习全局-局部关系；动态“重建+预测”纳入短期动力学；联合训练稳定、可控平衡。
  - 风险点：动态loss通常更大，需α/β平衡；第4帧预测防“复制/平滑”捷径；坚持tube掩码以强化时序建模。

### Phase ② 强无感（TacQuad 锚点对齐）
- 目标：在配对样本上学习跨传感器“无感基准空间”，得到编码器 φ₁（teacher版本）。
- 输入：TacQuad四传感器配对（同物体同位置）。
- 方法：
  - Cross-sensor matching：配对样本正对比/相似性最大化（温度/队列/困难样本挖掘）。
  - Universal sensor token：随机替换为通用token，约束不同传感器映射到统一子空间。
  - 损失：L = L_match + λ_tok · L_tok。
- 指标：
  - TacQuad LoSO drop ≤ 5pp；域探针准确率≈随机（≈1/4）。
- 合理性：
  - 有锚点的显式对齐最直接有效；universal-token提供“无感先验”。
  - 风险点：对齐塌缩（需温度/大batch/负样本质量）、λ_tok过大导致表征漂移；需精心采样/校准。

### Phase ③ 三层输出联合训练（多任务，无弱无感）
- 目标：在 φ₁ 上学习显式触觉语义（物理/交互/接触），得到 φ₂。
- 输入：
  - 物理层：TAG（材质、硬度、粗糙）。
  - 交互层：Feel（抓取性、弯性）。
  - 接触层：TVL/YCB-Slide（滑移、力趋势）。
- 方法：
  - 多任务联合训练（GradNorm 或不确定性加权）。
  - 冻结 φ₁ 前几层（保护无感特性，避免被下游任务破坏）。
- 指标：
  - 各任务单独精度 ≥ baseline；总体平均性能 ≥ AnyTouch 同类。
- 合理性：
  - 显式任务能将底座表征“语义化”；多任务契合触觉的层级属性。
  - 风险点：任务冲突/负迁移（需权重自适应、梯度协同）、标注规模不均（采样再平衡）；冻结层数网格化搜索。

### Phase ④ 弱无感微调（无配对：DANN + token一致性）
- 目标：在全数据上进一步弱化传感器偏差，得到 φ₃（全域弱无感编码器）。
- 输入：全触觉数据（含 TacQuad、TAG、TVL、Feel 等）。
- 方法：
  - DANN域对抗：去除传感器ID（或数据集名）信息。
  - Token一致性：有/无传感器token输出一致，不依赖配对样本。
  - 权重/概率调度：λ_d 0.1→0.5（或1.0）线性升温；p_u（通用token概率）0→0.75。
- 指标：
  - LoSO（留一传感器）三头平均提升 ≥ +2pp；域探针≈随机；seen-domain性能稳定（下降>2pp需回调）。
- 合理性：
  - 无配对数据下的“低风险去域”方案；与②互补，解决锚点覆盖不足。
  - 风险点：灾难性遗忘（逐步升温、分层冻结、监控三头指标），域分类器过强导致欠表征（容量/正则控制）。

### Phase ⑤ 稳定化与收尾
- 目标：冻结 φ₃ 主干，仅微调多任务头，确保seen/unseen域稳定交付。
- 方法：必要时小幅BN/仿射参数调整，或轻量test-time adaptation。
- 指标：新传感器性能稳定；三层输出逻辑自洽（物理→交互→接触）。
- 合理性：交付前的“稳态化”步骤，降低域漂移与过拟合风险。

---

## 执行节奏与依赖
- 顺序：①（已具备实现）→ ②（依赖TacQuad配对元数据） → ③（任务标注清单/质量） → ④（全域无配对去域） → ⑤（收尾）。
- 并行准备：
  - 数据工程：TacQuad配对清洗、域标签定义（传感器/数据集）。
  - 评测基线：LoSO方案、域探针、各任务baseline脚本。
  - 监控看板：Wandb面板与三角指标、对齐与任务指标模板。

## 成功判据（阶段性Go/No-Go）
- Phase①：loss_total稳降；loss_ratio稳定；contribution≈期望；loss_dynamic=loss_recon+loss_pred 恒成立。
- Phase②：TacQuad LoSO drop ≤ 5pp；域探针≈随机。
- Phase③：三层任务≥baseline；总体≥AnyTouch同类；跨域稳定。
- Phase④：LoSO三头平均 ≥ +2pp；域探针≈随机；seen-domain不降（>2pp回调）。
- Phase⑤：新传感器稳定；三层输出结构一致。

## 风险与对策（跨阶段共性）
- 任务失衡：动态主导或静态主导 → α/β/GradNorm/不确定性加权，监控contribution闭环调整。
- 预测捷径：第4帧复制/平滑 → 增大或随机预测跨度，加入运动变化覆盖（对照实验，不破坏主线）。
- 对齐塌缩：温度、队列/负样本质量、困难样本挖掘；可视化与探针双重监控。
- 域遗忘：逐步升温、分层冻结、早停与回退开关（seen-domain三头跌>2pp立即回调）。
- 资源稳定：AMP、合适batch/accum_iter、梯度范数监控、异常（NaN/Inf）熔断器。

---

## 与当前代码实现的对齐点（Phase①）
- 已实现：
  - 静态/动态联合训练（同批 α·loss_static + β·loss_dynamic）。
  - 动态分解指标：loss_recon（前3帧）与 loss_pred（第4帧），并验证相加一致性。
  - Wandb三角指标与贡献度；Cosine+Warmup、AMP、DDP、梯度累积。
- 建议默认：
  - 平衡权重（如 α=0.75, β=0.25）优先，减少动态loss主导。
  - 面板新增“动态损失分解”看板用于诊断（loss_dynamic、loss_recon、loss_pred）。

---

## 最简执行线（落地优先级）
1) 跑通Phase①三组对比：baseline交替 / 联合等权 / 联合平衡（优先）。
2) 以三角指标与分解一致性判健康；若健康则继续，否则调α/β与学习率。
3) 并行准备TacQuad配对与域探针；到位后进入Phase②，建立无感锚点。
4) 推进Phase③多任务；Phase④弱无感补强；Phase⑤稳定化交付。


